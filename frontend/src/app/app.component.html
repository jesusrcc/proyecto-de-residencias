<div class="app">
  <aside class="sidebar card">
    <div class="brand">Identidad Académica</div>
    <div class="muted" style="font-size:13px">Plataforma de gestión de trayectoria</div>

    <nav class="nav" id="mainNav">
      <button [class.active]="activeView==='dashboard'" (click)="showView('dashboard')"><span class="material-icons">dashboard</span> Dashboard</button>
      <button [class.active]="activeView==='form'" (click)="showView('form')"><span class="material-icons">edit</span> Formulario</button>
      <button [class.active]="activeView==='cv'" (click)="showView('cv')"><span class="material-icons">description</span> Mi CV</button>
      <button [class.active]="activeView==='timeline'" (click)="showView('timeline')"><span class="material-icons">timeline</span> Línea de tiempo</button>
      <button [class.active]="activeView==='export'" (click)="showView('export')"><span class="material-icons">download</span> Exportar CV</button>
    </nav>

    <div style="margin-top:auto; font-size:13px; color:var(--muted)">Usuario: <strong>{{ session?.name || 'Investigador' }}</strong></div>
  </aside>

  <div class="main">
    <header class="topbar">
      <div class="search"><input [(ngModel)]="searchQuery" id="searchInput" placeholder="Buscar (publicación, curso...)"></div>
      <div class="actions">
        <button class="ghost" (click)="saveLocal()">Guardar (local)</button>

        <!-- abrir modal (login/register) -->
        <button id="loginBtnTop" class="ghost" (click)="openAuth('login')">
          {{ session?.name ? firstNameShort : 'Login' }}
        </button>

        <!-- avatar: al hacer click abre menú o modal -->
        <div class="avatar" (click)="session ? openProfileMenu() : openAuth('login')">
          {{ avatarInitials }}
        </div>

        <!-- botón de logout visible solo si hay sesión -->
        <button *ngIf="session" class="ghost" (click)="logoutFromUI()">Logout</button>
      </div>
    </header>

    <main class="content">
      <!-- Dashboard -->
      <section *ngIf="activeView==='dashboard'" class="card" style="display:block; width:100%;">
        <h2>Panel</h2>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <div class="card" style="flex:1; min-width:200px;">
            <h3 style="margin:0 0 8px 0;">Resumen</h3>
            <div class="muted">Publicaciones: <strong id="statPubs">{{ publications.length }}</strong></div>
            <div class="muted">Cursos: <strong id="statCourses">{{ courses.length }}</strong></div>
            <div class="muted">Hitos: <strong id="statMilestones">{{ milestones.length }}</strong></div>
          </div>

          <div class="card" style="flex:2; min-width:280px;">
            <h3 style="margin:0 0 8px 0;">Accesos rápidos</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="small-btn" (click)="showView('form')">Editar perfil</button>
              <button class="small-btn" (click)="showView('cv')">Ver CV</button>
              <button class="small-btn" (click)="showView('timeline')">Ver Línea de tiempo</button>
              <button class="small-btn" (click)="exportCv()">Exportar a PDF</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Form -->
      <section *ngIf="activeView==='form'" class="card form">
        <h2>Formulario de investigador</h2>

        <div class="section-title">
          <div>Datos personales</div>
          <div class="muted">Campos obligatorios marcados *</div>
        </div>

        <div class="row">
          <div class="col">
            <label>Nombre *</label>
            <input [(ngModel)]="firstName" id="firstName" type="text" placeholder="Nombre">
          </div>
          <div class="col">
            <label>Apellido *</label>
            <input [(ngModel)]="lastName" id="lastName" type="text" placeholder="Apellido">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Email *</label>
            <input [(ngModel)]="email" id="email" type="email" placeholder="correo@institucion.edu.mx">
          </div>
          <div class="col">
            <label>ORCID</label>
            <input [(ngModel)]="orcid" id="orcid" type="text" placeholder="0000-0000-0000-0000">
          </div>
        </div>

        <!-- Nueva fila: País, Google Scholar y SNIP (no obligatorio) -->
        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label>País</label>
            <!-- puedes cambiar a <select> con opciones si prefieres -->
            <input [(ngModel)]="country" id="country" type="text" placeholder="México">
          </div>

          <div class="col">
            <label>Google Scholar (URL)</label>
            <input [(ngModel)]="googleScholar" id="googleScholar" type="url" placeholder="https://scholar.google.com/citations?user=...">
          </div>
        </div>

        <div style="margin-top:8px; margin-bottom:12px;">
          <label>SNIP / Snippet (opcional)</label>
          <!-- campo libre para pegar código embed o texto del snippet; no obligatorio -->
          <textarea [(ngModel)]="snip" id="snip" placeholder="Pega aquí el snippet o identificador (no obligatorio)" rows="3"></textarea>
          <div class="muted" style="font-size:12px; margin-top:6px;">Este campo es opcional: puedes pegar un pequeño embed o identificador (por ejemplo, código HTML de un widget).</div>
        </div>

        <div style="margin-bottom:12px;">
          <label>Biografía / Resumen</label>
          <textarea [(ngModel)]="bio" id="bio" placeholder="Resumen breve de la trayectoria"></textarea>
        </div>

        <div class="section-title">
          <div>Publicaciones</div>
          <div><button class="small-btn" (click)="addPublication()">Agregar</button></div>
        </div>
        <ul class="list">
          <li *ngFor="let p of publications; let i = index" class="item">
            <div class="meta">
              <input [(ngModel)]="publications[i].title" placeholder="Título" style="width:100%; margin-bottom:6px;">
              <div style="display:flex; gap:8px;">
                <input [(ngModel)]="publications[i].journal" placeholder="Revista" style="flex:1">
                <input [(ngModel)]="publications[i].year" placeholder="Año" style="width:90px">
              </div>
            </div>
            <div class="actions">
              <button class="ghost" (click)="removePublication(i)">Eliminar</button>
            </div>
          </li>
        </ul>

        <div class="section-title">
          <div>Cursos y formación</div>
          <div><button class="small-btn" (click)="addCourse()">Agregar</button></div>
        </div>
        <ul class="list">
          <li *ngFor="let c of courses; let i = index" class="item">
            <div class="meta">
              <input [(ngModel)]="courses[i].name" placeholder="Nombre del curso" style="width:100%; margin-bottom:6px;">
              <div style="display:flex; gap:8px;">
                <input [(ngModel)]="courses[i].institution" placeholder="Institución" style="flex:1">
                <input [(ngModel)]="courses[i].date" type="date" style="width:150px">
              </div>
            </div>
            <div class="actions"><button class="ghost" (click)="removeCourse(i)">Eliminar</button></div>
          </li>
        </ul>

        <div class="section-title">
          <div>Hitos / Trayectoria</div>
          <div><button class="small-btn" (click)="addMilestone()">Agregar</button></div>
        </div>
        <ul class="list">
          <li *ngFor="let m of milestones; let i = index" class="item">
            <div class="meta">
              <input [(ngModel)]="milestones[i].title" placeholder="Título del hito" style="width:100%; margin-bottom:6px;">
              <div style="display:flex; gap:8px;">
                <input [(ngModel)]="milestones[i].date" type="date" style="width:160px">
                <select [(ngModel)]="milestones[i].type" style="flex:1">
                  <option value="otro">Otro</option>
                  <option value="curso">Curso</option>
                  <option value="publicacion">Publicación</option>
                  <option value="puesto">Puesto</option>
                </select>
              </div>
              <input [(ngModel)]="milestones[i].description" placeholder="Descripción breve" style="width:100%; margin-top:6px;">
            </div>
            <div class="actions"><button class="ghost" (click)="removeMilestone(i)">Eliminar</button></div>
          </li>
        </ul>

        <div class="actions-row">
          <button class="small-btn" (click)="saveLocal()">Guardar (local)</button>
          <button class="small-btn" (click)="saveServer()">Guardar (server)</button>

          <button class="ghost" (click)="resetForm()">Borrar formulario</button>
          <div style="margin-left:auto;"><button class="small-btn" (click)="showView('cv')">Ver CV</button></div>
        </div>
      </section>

      <!-- CV -->
      <section *ngIf="activeView==='cv'" class="card cv" #cvElement>
        <aside class="cv-left">
          <img [src]="photoUrl || 'https://via.placeholder.com/120'" class="photo" alt="Foto">
          <h3 id="cvName">{{ firstName || 'Nombre' }} {{ lastName || 'Apellido' }}</h3>
          <div class="muted" id="cvAffil">Departamento / Institución</div>
          <div style="margin-top:10px; font-size:14px;">
            <div id="cvOrcid" class="muted">{{ orcid ? ('ORCID: ' + orcid) : '' }}</div>
            <div id="cvCountry" class="muted" *ngIf="country" style="margin-top:6px">País: {{ country }}</div>

            <div id="cvEmail" class="muted" style="margin-top:6px">{{ email }}</div>

            <!-- Google Scholar: show as link when provided -->
            <div *ngIf="googleScholar" style="margin-top:6px;">
              <a [href]="googleScholar" target="_blank" rel="noopener noreferrer">Google Scholar</a>
            </div>

            <!-- SNIP snippet: si hay contenido, mostrarlo (se asume texto/HTML pequeño) -->
            <div id="cvSnip" *ngIf="snip" style="margin-top:8px;">
              <div class="muted" style="font-size:12px; margin-bottom:6px;">SNIP / Snippet:</div>
              <!-- Si quieres interpretar HTML embebido, reemplaza innerText por innerHTML en TS con sanitización -->
              <div style="font-size:13px; white-space:pre-wrap;">{{ snip }}</div>
            </div>
          </div>
        </aside>

        <div class="cv-right">
          <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
            <h1>Trayectoria académica</h1>
            <div>
              <button class="small-btn" (click)="exportCv()">Exportar a PDF</button>
              <button class="ghost" (click)="showView('form')">Editar</button>
            </div>
          </div>

          <section>
            <h2>Producción académica</h2>
            <ol id="cvPubs">
              <li *ngFor="let p of publications">{{ p.title }} <span *ngIf="p.journal">, {{ p.journal }}</span> <span *ngIf="p.year"> — {{ p.year }}</span></li>
              <li *ngIf="publications.length === 0" class="muted">Sin publicaciones registradas.</li>
            </ol>
          </section>

          <section>
            <h2>Cursos y formación</h2>
            <ul id="cvCourses">
              <li *ngFor="let c of courses">{{ c.name }} <span *ngIf="c.institution"> — {{ c.institution }}</span> <span *ngIf="c.date"> ({{ c.date }})</span></li>
              <li *ngIf="courses.length === 0" class="muted">Sin cursos registrados.</li>
            </ul>
          </section>

          <section>
            <h2>Hitos</h2>
            <ul id="cvMilestones">
              <li *ngFor="let m of milestones">{{ m.date }} — <strong>{{ m.title }}</strong> <span *ngIf="m.description">- {{ m.description }}</span></li>
              <li *ngIf="milestones.length === 0" class="muted">Sin hitos registrados.</li>
            </ul>
          </section>
        </div>
      </section>

      <!-- Timeline -->
      <aside *ngIf="activeView==='timeline'" class="card timeline">
        <h2>Línea de tiempo</h2>
        <div style="position:relative; margin-top:8px;">
          <div *ngIf="milestones.length === 0" class="muted">No hay hitos para mostrar.</div>
          <div *ngFor="let m of sortedMilestones"
     class="item" style="display:flex; gap:12px; margin-bottom:14px; padding-left:16px;">

            <div style="width:80px; text-align:right; padding-right:12px; font-size:13px; color:var(--muted)">{{ m.date }}</div>
            <div class="dot"></div>
            <div class="content"><strong>{{ m.title }}</strong><div style="font-size:13px; color:var(--muted); margin-top:6px">{{ m.description }}</div></div>
          </div>
        </div>
      </aside>

      <!-- Export placeholder -->
      <section *ngIf="activeView==='export'" class="card" style="width:100%;">
        <h2>Exportar CV</h2>
        <p class="muted">Haz clic en "Exportar a PDF" dentro de la vista de CV para generar un PDF listo para impresión o envío.</p>
        <button class="small-btn" (click)="showView('cv')">Ir a CV</button>
      </section>
    </main>
  </div>
</div>

<!-- AUTH MODAL: Login / Registro (controlado por AppComponent) -->
<div class="auth-wrapper" *ngIf="showAuth" (click)="closeAuth()">
  <div class="auth-card" (click)="$event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <h3>{{ authMode === 'login' ? 'Iniciar sesión' : 'Registro de usuario' }}</h3>
      <button class="link-btn" (click)="closeAuth()">Cerrar ✕</button>
    </div>

    <div class="tabs">
      <button [class.active]="authMode==='login'" (click)="authMode='login'">Iniciar sesión</button>
      <button [class.active]="authMode==='register'" (click)="authMode='register'">Registrarse</button>
    </div>

    <div class="content">
      <!-- LOGIN -->
      <form *ngIf="authMode==='login'" (ngSubmit)="modalLogin()">
        <label>Correo</label>
        <input type="email" [(ngModel)]="loginEmail" name="loginEmail" required />

        <label>Contraseña</label>
        <input type="password" [(ngModel)]="loginPwd" name="loginPwd" required />

        <button type="submit" class="btn">Entrar</button>
      </form>

      <!-- REGISTER -->
      <form *ngIf="authMode==='register'" (ngSubmit)="modalRegister()">
        <label>Nombre</label>
        <input type="text" [(ngModel)]="regName" name="regName" required />

        <label>Correo</label>
        <input type="email" [(ngModel)]="regEmail" name="regEmail" required />

        <label>Contraseña</label>
        <input type="password" [(ngModel)]="regPwd" name="regPwd" required />

        <label>Confirmar contraseña</label>
        <input type="password" [(ngModel)]="regPwd2" name="regPwd2" required />

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button type="button" class="ghost" (click)="closeAuth()">Volver</button>
          <button type="submit" class="btn">Registrar</button>
        </div>
      </form>
    </div>

    <div class="msg" *ngIf="authMsg">{{ authMsg }}</div>
  </div>
</div>
