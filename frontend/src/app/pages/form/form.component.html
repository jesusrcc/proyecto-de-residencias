<div class="form-container">
  <h1>Formulario de investigador</h1>

  <form #investigadorForm="ngForm" (ngSubmit)="save()" class="form">
    <!-- ================= DATOS PERSONALES ================= -->
    <fieldset>
      <legend>Datos personales</legend>

      <div class="profile-header">
        <div class="photo-section">

          <!-- Caja igual al bot√≥n de AGREGAR -->
          <div class="profile-upload-box" (click)="triggerFileInput()">

            <!-- Foto cargada -->
            <img
              *ngIf="user.photoUrl"
              [src]="user.photoUrl"
              class="profile-photo"
              alt="Foto del investigador"
            />

            <!-- Placeholder estilo ‚Äú+‚Äù -->
            <div *ngIf="!user.photoUrl" class="profile-placeholder">
              +
            </div>

            <!-- Bot√≥n eliminar -->
            <button
              *ngIf="user.photoUrl"
              type="button"
              class="remove-profile-btn"
              (click)="deleteProfilePhoto($event)">
              ‚úñ
            </button>

            <input type="file"
                  #fileInput
                  accept="image/*"
                  hidden
                  (change)="onFileSelected($event)" />
          </div>

          <small class="photo-hint">
            Haz clic para subir o cambiar la foto
          </small>

        </div>



        <!-- üßæ Campos personales -->
        <div class="personal-info">
          <div class="row">
            <div class="field">
              <label>Nombre <span class="required">*</span></label>
              <input
                [(ngModel)]="user.name"
                name="name"
                type="text"
                required
                #name="ngModel"
              />
              <small class="error" *ngIf="name.invalid && name.touched">
                Este campo es obligatorio.
              </small>
            </div>

            <div class="field">
              <label>Primer apellido <span class="required">*</span></label>
              <input
                [(ngModel)]="user.firstName"
                name="firstName"
                type="text"
                required
                #firstName="ngModel"
              />
              <small class="error" *ngIf="firstName.invalid && firstName.touched">
                Este campo es obligatorio.
              </small>
            </div>

            <div class="field">
              <label>Segundo apellido <span class="required">*</span></label>
              <input
                [(ngModel)]="user.lastName"
                name="lastName"
                type="text"
                required
                #lastName="ngModel"
              />
              <small class="error" *ngIf="lastName.invalid && lastName.touched">
                Este campo es obligatorio.
              </small>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Correo electr√≥nico <span class="required">*</span></label>
              <input
                [(ngModel)]="user.email"
                name="email"
                type="email"
                required
                #email="ngModel"
              />
              <small class="error" *ngIf="email.invalid && email.touched">
                Ingresa un correo v√°lido.
              </small>
            </div>

            <div class="field">
              <label>Pa√≠s <span class="required">*</span></label>
              <input
                [(ngModel)]="user.country"
                name="country"
                type="text"
                required
                #country="ngModel"
              />
              <small class="error" *ngIf="country.invalid && country.touched">
                Este campo es obligatorio.
              </small>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>ORCID</label>
              <input
                [(ngModel)]="user.orcid"
                name="orcid"
                placeholder="0000-0000-0000-0000"
              />
            </div>
            <div class="field">
              <label>Google Scholar</label>
              <input
                [(ngModel)]="user.googleScholar"
                name="googleScholar"
                placeholder="https://scholar.google.com/..."
              />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>SNIP</label>
              <input
                [(ngModel)]="user.snip"
                name="snip"
                placeholder="√çndice SNIP del investigador"
                type="text"
              />
            </div>
          </div>
          <div class="field">
            <label>Biograf√≠a / Resumen</label>
            <textarea
              [(ngModel)]="user.bio"
              name="bio"
              rows="3"
              placeholder="Escribe una breve descripci√≥n..."
            ></textarea>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- ================= PUBLICACIONES ================= -->
    <fieldset>
      <legend>Publicaciones</legend>

      <div *ngFor="let pub of user.publications; let i = index" class="item-row">
        <input
          [(ngModel)]="pub.title"
          name="pubTitle{{ i }}"
          placeholder="T√≠tulo de la publicaci√≥n"
        />
        <input
          [(ngModel)]="pub.journal"
          name="pubJournal{{ i }}"
          placeholder="Revista"
        />
        <input
          type="date"
          [(ngModel)]="pub.date"
          name="pubDate{{ i }}"
          (keydown)="$event.preventDefault()"
          (paste)="$event.preventDefault()"
          (drop)="$event.preventDefault()"
          min="1950-01-01"
          [max]="today"
        />
        <button type="button" class="remove-btn" (click)="removeItem('publications', i)">
          Eliminar
        </button>
      </div>

      <button type="button" class="add-btn" (click)="addItem('publications')">Agregar</button>
    </fieldset>

    <!-- ================= CURSOS ================= -->
    <fieldset>
      <legend>Cursos y formaci√≥n</legend>

      <div *ngFor="let course of user.courses; let i = index" class="item-row">
        <input
          [(ngModel)]="course.title"
          name="courseTitle{{ i }}"
          placeholder="Nombre del curso o formaci√≥n"
        />
        <input
          [(ngModel)]="course.institution"
          name="courseInstitution{{ i }}"
          placeholder="Instituci√≥n"
        />
        <input
          type="date"
          [(ngModel)]="course.date"
          name="courseDate{{ i }}"
          (keydown)="$event.preventDefault()"
          (paste)="$event.preventDefault()"
          (drop)="$event.preventDefault()"
          min="1950-01-01"
          [max]="today"
        />
        <button type="button" class="remove-btn" (click)="removeItem('courses', i)">
          Eliminar
        </button>
      </div>

      <button type="button" class="add-btn" (click)="addItem('courses')">Agregar</button>
    </fieldset>

    <!-- ================= HITOS ================= -->
    <fieldset>
      <legend>Hitos / Trayectoria</legend>

      <div *ngFor="let milestone of user.milestones; let i = index" class="item-row">
        <input
          [(ngModel)]="milestone.title"
          name="mileTitle{{ i }}"
          placeholder="T√≠tulo del hito"
        />
        <input
          type="date"
          [(ngModel)]="milestone.date"
          name="mileDate{{ i }}"
          (keydown)="$event.preventDefault()"
          (paste)="$event.preventDefault()"
          (drop)="$event.preventDefault()"
          min="1950-01-01"
          [max]="today"
        />
        <select [(ngModel)]="milestone.type" name="mileType{{ i }}">
          <option value="Puesto">Puesto</option>
          <option value="Publicaci√≥n">Publicaci√≥n</option>
          <option value="Curso">Curso</option>
          <option value="Otro">Otro</option>
        </select>
        <input
          [(ngModel)]="milestone.description"
          name="mileDescription{{ i }}"
          placeholder="Descripci√≥n breve"
        />
        <button type="button" class="remove-btn" (click)="removeItem('milestones', i)">
          Eliminar
        </button>
      </div>

      <button type="button" class="add-btn" (click)="addItem('milestones')">Agregar</button>
    </fieldset>
      <!-- ================= GALER√çA DE RECONOCIMIENTOS ================= -->
    <fieldset>
      <legend>Galer√≠a de fotos (reconocimientos, diplomas, etc.)</legend>

      <div class="gallery-container">
        <div class="gallery-grid">
          <div class="gallery-item" *ngFor="let img of user.gallery; let i = index">
            <img [src]="img" class="gallery-preview">

            <button type="button"
                    class="remove-gallery-btn"
                    (click)="removeGalleryImage(i)">
              ‚úñ
            </button>
          </div>

          <!-- Bot√≥n agregar -->
          <div class="gallery-add" (click)="triggerGalleryInput()">
            <span>+</span>
            <input type="file"
                  accept="image/*"
                  multiple
                  #galleryInput
                  hidden
                  (change)="onGallerySelected($event)">
          </div>
        </div>
      </div>
    </fieldset>

    <button type="submit" [disabled]="investigadorForm.invalid || loading">
      {{ loading ? 'Guardando...' : 'Guardar cambios' }}
    </button>

    <!-- üîî TOAST GLOBAL PARA FORMULARIO -->
    <div class="toast-container" *ngIf="message">
      <div class="toast" [ngClass]="messageType">
        <i *ngIf="messageType === 'success'" class="fa-solid fa-check"></i>
        <i *ngIf="messageType === 'error'" class="fa-solid fa-xmark"></i>
        <i *ngIf="messageType === 'warning'" class="fa-solid fa-exclamation"></i>
        <i *ngIf="messageType === 'info'" class="fa-solid fa-info"></i>
        {{ message }}
      </div>
    </div>
  </form>
</div>
